generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ----------------------------------------------------
//  ENUMS
// ----------------------------------------------------

enum Role {
  ADMIN
  USER
  MANAGER
  DEALER
  SALES_REP
  PARTNER
}

// ----------------------------------------------------
//  USER MODEL
// ----------------------------------------------------

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  role      Role     @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ----------------------------------------------------
//  BRAND MODEL
// ----------------------------------------------------

model Brand {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?

  categories BrandCategory[]
  products   BrandProduct[]

  identity BrandIdentity?
  rules    BrandRules?
  pricing  BrandPricing?
  aiConfig BrandAIConfig?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ----------------------------------------------------
//  BRAND CATEGORY
// ----------------------------------------------------

model BrandCategory {
  id      String @id @default(cuid())
  name    String
  slug    String @unique
  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id])

  products BrandProduct[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ----------------------------------------------------
//  BRAND PRODUCT
// ----------------------------------------------------

model BrandProduct {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  price       Float
  imageUrl    String?

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id])

  categoryId String?
  category   BrandCategory? @relation(fields: [categoryId], references: [id])

  sku            String? @unique
  upc            String?
  line           String?
  status         String?
  weightGrams    Float?
  netContentMl   Float?
  unitsPerCarton Int?
  qrUrl          String?

  // العلاقات السابقة
  pricing          ProductPricing?
  competitorPrices CompetitorPrice[]
  priceDrafts      ProductPriceDraft[]

  // علاقات V10 الجديدة
  priceHistory    AIPricingHistory[]
  learningJournal AILearningJournal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ----------------------------------------------------
//  BRAND IDENTITY
// ----------------------------------------------------

model BrandIdentity {
  id      String @id @default(cuid())
  brandId String @unique
  brand   Brand  @relation(fields: [brandId], references: [id])

  vision         String?
  mission        String?
  values         String?
  toneOfVoice    String?
  persona        String?
  brandStory     String?
  keywords       String?
  colorPalette   String?
  guidelineUrl   String?
  packagingStyle String?
  socialProfiles String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ----------------------------------------------------
//  BRAND RULES
// ----------------------------------------------------

model BrandRules {
  id      String @id @default(cuid())
  brandId String @unique
  brand   Brand  @relation(fields: [brandId], references: [id])

  namingRules      String?
  descriptionRules String?
  messagingRules   String?
  marketingRules   String?
  discountRules    String?
  pricingRules     String?
  stockRules       String?
  restrictedWords  String?
  allowedWords     String?
  aiRestrictions   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ----------------------------------------------------
//  BRAND PRICING
// ----------------------------------------------------

model BrandPricing {
  id      String @id @default(cuid())
  brandId String @unique
  brand   Brand  @relation(fields: [brandId], references: [id])

  costMultiplier      Float?
  wholesaleMultiplier Float?
  retailMultiplier    Float?
  standDiscount       Float?
  onlineDiscount      Float?
  dealerDiscount      Float?
  loyaltyEarnRate     Float?
  loyaltyRedeemRate   Float?
  aiDynamicPricing    Boolean @default(false)
  aiMarketFactor      Float?
  aiCompetitionFactor Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ----------------------------------------------------
//  PRODUCT PRICING (from CSV file)
// ----------------------------------------------------

model ProductPricing {
  id        String       @id @default(cuid())
  productId String       @unique
  product   BrandProduct @relation(fields: [productId], references: [id])

  factoryPriceUnit        Float?
  totalFactoryPriceCarton Float?
  eprLucidPerUnit         Float?
  shippingInboundPerUnit  Float?
  gs1PerUnit              Float?
  retailPackagingPerUnit  Float?
  qcPifPerUnit            Float?
  operationsPerUnit       Float?
  marketingPerUnit        Float?
  cogsEur                 Float?
  fullCostEur             Float?
  uvpNet                  Float?
  uvpInc                  Float?
  map                     Float?
  grundpreis              String?
  vatPct                  Float?
  b2cStoreNet             Float?
  b2cStoreInc             Float?
  b2cMarginPct            Float?
  amazonTierKey           String?
  amazonNet               Float?
  amazonInc               Float?
  amazonMarginPct         Float?
  dealerBasicNet          Float?
  dealerPlusNet           Float?
  standPartnerNet         Float?
  distributorNet          Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ----------------------------------------------------
//  BRAND AI CONFIG
// ----------------------------------------------------

model BrandAIConfig {
  id      String @id @default(cuid())
  brandId String @unique
  brand   Brand  @relation(fields: [brandId], references: [id])

  aiPersonality    String?
  aiVoiceStyle     String?
  aiContentStyle   String?
  aiPricingStyle   String?
  aiEnabledActions String?
  aiBlockedTopics  String?
  aiModelVersion   String?
  aiTone           String?
  aiWritingRules   String?
  aiPricingRules   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ----------------------------------------------------
//  ProductPriceDraft
// ----------------------------------------------------

model ProductPriceDraft {
  id        String   @id @default(cuid())
  productId String
  channel   String
  oldNet    Float?
  oldGross  Float?
  oldMargin Float?
  newNet    Float?
  newGross  Float?
  newMargin Float?
  changePct Float?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product BrandProduct @relation(fields: [productId], references: [id])
}

// ----------------------------------------------------
//   CompetitorPrice
// ----------------------------------------------------

model CompetitorPrice {
  id        String       @id @default(cuid())
  productId String
  product   BrandProduct @relation(fields: [productId], references: [id])

  competitor String // اسم المنافس (DM, Rossmann, Amazon Seller...)
  channel    String? // B2C, AMAZON, DEALER, ...
  netPrice   Float? // السعر الصافي (بدون ضريبة)
  grossPrice Float? // السعر مع الضريبة
  currency   String  @default("EUR")
  url        String? // رابط صفحة المنتج عند المنافس

  collectedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ----------------------------------------------------
//   AIPricingHistory
// ----------------------------------------------------

model AIPricingHistory {
  id        String @id @default(cuid())
  productId String
  channel   String

  oldNet         Float?
  newNet         Float?
  recommendedPct Float?
  appliedPct     Float?

  aiScore Float?
  mode    String?

  marginBefore Float?
  marginAfter  Float?

  competitorBefore Float?
  competitorAfter  Float?

  stockBefore Float?
  stockAfter  Float?

  demandBefore Float?
  demandAfter  Float?

  salesChangePct Float?

  createdAt DateTime @default(now())

  product BrandProduct @relation(fields: [productId], references: [id])
}

// ----------------------------------------------------
//   AIPricingWeights
// ----------------------------------------------------

model AIPricingWeights {
  id   String @id @default(cuid())
  mode String @unique

  marginWeight     Float @default(0.3)
  costWeight       Float @default(0.25)
  competitorWeight Float @default(0.3)
  stockWeight      Float @default(0.15)

  lastUpdated DateTime @default(now())
}

// ----------------------------------------------------
//   AILearningJournal
// ----------------------------------------------------

model AILearningJournal {
  id        String   @id @default(cuid())
  productId String
  channel   String
  signal    String
  value     Float?
  notes     String?
  createdAt DateTime @default(now())

  product BrandProduct @relation(fields: [productId], references: [id])
}
